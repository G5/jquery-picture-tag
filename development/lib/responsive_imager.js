// Generated by CoffeeScript 1.3.3
(function() {
  var $,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  $ = jQuery;

  this.ResponsiveImage = (function() {

    function ResponsiveImage($el) {
      this.$el = $el;
      this._replacePictureImgSrcWithBestSourceSrcsetSrc = __bind(this._replacePictureImgSrcWithBestSourceSrcsetSrc, this);

      this.largestMediaMinWidth = 0;
      this.newSrc = void 0;
      this._replacePictureImgSrcWithBestSourceSrcsetSrc();
      this._onResizeReplacePictureImgSrcWithBestSourceSrcsetSrc();
    }

    ResponsiveImage.prototype._onResizeReplacePictureImgSrcWithBestSourceSrcsetSrc = function() {
      return $(window).resize(this._replacePictureImgSrcWithBestSourceSrcsetSrc);
    };

    ResponsiveImage.prototype._replacePictureImgSrcWithBestSourceSrcsetSrc = function() {
      var smallestSource,
        _this = this;
      this.largestMediaMinWidth = 0;
      smallestSource = this.$el.children("source:not([media])");
      this.newSrc = this._getSrcFromSrcset(smallestSource);
      this.$el.children("source").each(function(i, el) {
        return _this._keepSrcIfBestMediaMatch(el);
      });
      return this._setPictureImgSrc(this.$el, this.newSrc);
    };

    ResponsiveImage.prototype._keepSrcIfBestMediaMatch = function(el) {
      var mediaQuery, mediaQueryMinWidth;
      mediaQuery = $(el).attr("media");
      if (matchMedia(mediaQuery).matches) {
        mediaQueryMinWidth = this._getMediaQueryMinWidth(mediaQuery);
        if (mediaQueryMinWidth >= this.largestMediaMinWidth) {
          this.largestMediaMinWidth = mediaQueryMinWidth;
          return this.newSrc = this._getSrcFromSrcset($(el));
        }
      }
    };

    ResponsiveImage.prototype._getMediaQueryMinWidth = function(mediaQuery) {
      return mediaQuery.match(/\d+/);
    };

    ResponsiveImage.prototype._setPictureImgSrc = function($el, value) {
      return $el.children("img").attr("src", value);
    };

    ResponsiveImage.prototype._getSrcFromSrcset = function($el) {
      return this._getSrcset($el).match(/^\S+/)[0];
    };

    ResponsiveImage.prototype._getSrcset = function($el) {
      return $el.attr("srcset");
    };

    return ResponsiveImage;

  })();

  $.fn.makeResponsive = function() {
    var $pictures;
    $pictures = this;
    return $pictures.each(function() {
      var ri;
      return ri = new ResponsiveImage($(this));
    });
  };

}).call(this);
